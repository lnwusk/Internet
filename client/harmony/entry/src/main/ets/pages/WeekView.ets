import { CourseService } from '../services/CourseService';
import { StudyTaskService } from '../services/StudyTaskService';
import { WeekScheduleData, TimeSlot, CourseBasic, CourseDetail, CourseScheduleItem, StudyTask } from '../common/models/ApiModels';
import { Logger } from '../common/utils/Logger';
import common from '@ohos.app.ability.common';
import router from '@ohos.router';
import { CourseDetailDialog } from './CourseDetailDialog';
import { StudyTaskDialog } from './StudyTaskDialog';

class ScheduleRow {
  start: string = '';
  end: string = '';
  type: number = 0;
  label: string = '';
}

class SlotInfo {
  isStart: boolean = false;
  span: number = 1;
  course: TimeSlot = new TimeSlot();
}

// å­¦ä¹ ä»»åŠ¡æ—¶é—´æ§½ä¿¡æ¯
class TaskSlotInfo {
  isStart: boolean = false;
  task: StudyTask = new StudyTask();
}

// ä»»åŠ¡ä½ç½®ä¿¡æ¯
class TaskPosition {
  x: number = 0;
  y: number = 0;
  rowIndex: number = -1;
}

@Component
export struct WeekView {
  @State weekData: WeekScheduleData = new WeekScheduleData();
  @State studyTasks: StudyTask[] = [];  // å­¦ä¹ ä»»åŠ¡åˆ—è¡¨
  @State isLoading: boolean = false;
  @State currentWeekIndex: number = 1;
  @State currentSemester: string = '2025-2026-1';
  private semesterOptions: SelectOption[] = [
    { value: '2025-2026-1' },
    { value: '2024-2025-2' },
    { value: '2024-2025-1' },
    { value: '2023-2024-2' },
    { value: '2023-2024-1' }
  ];

  @StorageLink('needRefreshSchedule') @Watch('onRefreshNeeded') refreshFlag: number = 0;
  
  // å¼¹çª—æ§åˆ¶å™¨
  private selectedCourse: CourseDetail = new CourseDetail();
  private selectedSlot: TimeSlot = new TimeSlot();
  
  dialogController: CustomDialogController = new CustomDialogController({
    builder: CourseDetailDialog({
      course: this.selectedCourse,
      currentSlot: this.selectedSlot,
      onDeleteSuccess: () => {
         this.loadSchedule();
      }
    }),
    autoCancel: true,
    customStyle: true
  });

  // å­¦ä¹ ä»»åŠ¡å¼¹çª—æ•°æ®
  @State selectedTask: StudyTask | undefined = undefined;
  @State presetDate: string = '';
  @State presetStartTime: string = '';

  taskDialogController: CustomDialogController = new CustomDialogController({
    builder: StudyTaskDialog({
      editTask: this.selectedTask,
      presetDate: this.presetDate,
      presetStartTime: this.presetStartTime,
      onSuccess: () => {
        this.loadSchedule();
      }
    }),
    autoCancel: true,
    customStyle: true
  });

  // æ‹–æ‹½ç›¸å…³çŠ¶æ€
  @State draggingTask: StudyTask | null = null;
  @State dragOffsetY: number = 0;
  @State dragOffsetX: number = 0;
  @State isDragging: boolean = false;

  private context: common.UIAbilityContext | null = null;
  private weekDays: string[] = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

  // æ‰“å¼€è¯¾ç¨‹è¯¦æƒ…
  showCourseDetail(course: CourseDetail, slot: TimeSlot) {
      this.selectedCourse = course;
      this.selectedSlot = slot;
      this.dialogController.open();
  }

  // æ‰“å¼€ä»»åŠ¡å¼¹çª—(æ–°å»º)
  openNewTaskDialog(day: number, startTime: string) {
    // è®¡ç®—å½“å‰å‘¨çš„å…·ä½“æ—¥æœŸ
    const today = new Date();
    const dayOfWeek = today.getDay() || 7;
    const diff = day - dayOfWeek;
    const targetDate = new Date(today);
    targetDate.setDate(today.getDate() + diff);

    const year = targetDate.getFullYear();
    const month = (targetDate.getMonth() + 1).toString().padStart(2, '0');
    const dayStr = targetDate.getDate().toString().padStart(2, '0');

    this.selectedTask = undefined;
    this.presetDate = `${year}-${month}-${dayStr}`;
    this.presetStartTime = startTime;
    this.taskDialogController.open();
  }

  // æ‰“å¼€ä»»åŠ¡å¼¹çª—(ç¼–è¾‘)
  openEditTaskDialog(task: StudyTask) {
    this.selectedTask = task;
    this.presetDate = '';
    this.presetStartTime = '';
    this.taskDialogController.open();
  }

  private rows: ScheduleRow[] = [
    { start: '08:00', end: '08:50', type: 0, label: '1' },
    { start: '09:00', end: '09:50', type: 0, label: '2' },
    { start: '10:10', end: '11:00', type: 0, label: '3' },
    { start: '11:10', end: '12:00', type: 0, label: '4' },
    { start: '12:00', end: '14:00', type: 1, label: 'åˆä¼‘' },
    { start: '14:00', end: '14:50', type: 0, label: '5' },
    { start: '15:00', end: '15:50', type: 0, label: '6' },
    { start: '16:10', end: '17:00', type: 0, label: '7' },
    { start: '17:10', end: '18:00', type: 0, label: '8' },
    { start: '18:00', end: '18:30', type: 1, label: 'æ™šé¥­' },
    { start: '18:30', end: '19:20', type: 0, label: '9' },
    { start: '19:30', end: '20:20', type: 0, label: '10' },
    { start: '20:30', end: '21:20', type: 0, label: '11' },
    { start: '21:30', end: '22:00', type: 1, label: 'æ™šä¼‘' }
  ];

  aboutToAppear() {
    this.context = getContext(this) as common.UIAbilityContext;
    this.loadSchedule();
  }

  onRefreshNeeded() {
    if (this.refreshFlag > 0) {
      Logger.info('WeekView: Refresh flag changed, reloading schedule');
      try {
        this.loadSchedule();
      } catch (err) {
        Logger.error('WeekView: Refresh failed, ignoring error');
      }
    }
  }

  async loadSchedule() {
    if (!this.context) return;
    this.isLoading = true;
    try {
      // åŠ è½½è¯¾ç¨‹æ•°æ®
      const courseResponse = await CourseService.getWeekSchedule(this.context, this.currentWeekIndex, this.currentSemester);
      if (courseResponse.code === 200 && courseResponse.data) {
        this.weekData = courseResponse.data;
        this.currentWeekIndex = courseResponse.data.requestedWeek;
        if (courseResponse.data.semester) {
             this.currentSemester = courseResponse.data.semester;
        }
      }

      // åŠ è½½å­¦ä¹ ä»»åŠ¡ï¼ˆä¸ä¼ weekå‚æ•°ï¼Œè·å–æ‰€æœ‰ä»»åŠ¡ï¼‰
      const taskResponse = await StudyTaskService.getStudyTasks(this.context);
      if (taskResponse.code === 200 && taskResponse.data && taskResponse.data.tasks) {
        // è·å–å½“å‰å‘¨çš„æ—¥æœŸèŒƒå›´
        const weekDates = this.getWeekDates(this.currentWeekIndex);
        // è¿‡æ»¤å½“å‰å‘¨çš„ä»»åŠ¡
        this.studyTasks = taskResponse.data.tasks.filter(t =>
          weekDates.includes(t.scheduledDate)
        );
        Logger.info(`Loaded ${this.studyTasks.length} study tasks for week ${this.currentWeekIndex}`);
        Logger.info(`All tasks: ${taskResponse.data.tasks.length}, Week dates: ${weekDates.join(', ')}`);
      }
    } catch (err) {
      Logger.error('Failed to load schedule:', JSON.stringify(err));
    } finally {
      this.isLoading = false;
    }
  }

  private lightColors: string[] = [
    '#FFEBEE', '#FFCDD2', '#F3E5F5', '#E1BEE7',
    '#E8EAF6', '#C5CAE9', '#E3F2FD', '#BBDEFB',
    '#E0F7FA', '#B2EBF2', '#E0F2F1', '#B2DFDB',
    '#E8F5E9', '#C8E6C9', '#F1F8E9', '#DCEDC8',
    '#FFFDE7', '#FFF9C4', '#FFF3E0', '#FFE0B2'
  ];

  // å­¦ä¹ ä»»åŠ¡ä½¿ç”¨ç»¿è‰²/æ©™è‰²ç³»
  private taskColors: string[] = [
    '#C8E6C9', '#A5D6A7', '#81C784',  // ç»¿è‰²ç³» (pending)
    '#FFE0B2', '#FFCC80', '#FFB74D'   // æ©™è‰²ç³» (in-progress)
  ];
  
  getSafeColor(courseName: string): string {
    let hash = 0;
    for (let i = 0; i < courseName.length; i++) {
        hash = ((hash << 5) + hash) + courseName.charCodeAt(i);
    }
    hash = Math.imul(hash, 16777619);
    
    const index = Math.abs(hash) % this.lightColors.length;
    return this.lightColors[index];
  }

  // è·å–æŒ‡å®šå‘¨æ¬¡çš„7å¤©æ—¥æœŸåˆ—è¡¨ (YYYY-MM-DDæ ¼å¼)
  getWeekDates(weekIndex: number): string[] {
    // å­¦æœŸå¼€å§‹æ—¥æœŸæ˜¯2026-01-12ï¼ˆå‘¨ä¸€ï¼‰
    // ç¬¬1å‘¨: 01-12(å‘¨ä¸€) åˆ° 01-18(å‘¨æ—¥)
    // ç¬¬2å‘¨: 01-19(å‘¨ä¸€) åˆ° 01-25(å‘¨æ—¥)
    const semesterStart = new Date('2026-01-12');
    const weekStart = new Date(semesterStart);
    weekStart.setDate(semesterStart.getDate() + (weekIndex - 1) * 7);

    const dates: string[] = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart);
      d.setDate(weekStart.getDate() + i);
      const year = d.getFullYear();
      const month = (d.getMonth() + 1).toString().padStart(2, '0');
      const day = d.getDate().toString().padStart(2, '0');
      dates.push(`${year}-${month}-${day}`);
    }

    return dates;
  }

  // è®¡ç®—æ—¥æœŸå¯¹åº”çš„æ˜ŸæœŸå‡  (1-7)
  getDateDayOfWeek(dateStr: string): number {
    const date = new Date(dateStr);
    const day = date.getDay();
    return day === 0 ? 7 : day;
  }

  // è·å–å­¦ä¹ ä»»åŠ¡ï¼ˆåªåŒ¹é…å¼€å§‹æ—¶é—´æ‰€åœ¨æ—¶æ®µï¼‰
  getTaskInfo(day: number, rowIndex: number): TaskSlotInfo | null {
    const rowStart = this.rows[rowIndex].start;
    const rowEnd = this.rows[rowIndex].end;

    // åªåŒ¹é…ä»»åŠ¡å¼€å§‹æ—¶é—´è½åœ¨è¯¥æ—¶æ®µå†…
    const task = this.studyTasks.find(t => {
      const taskDay = this.getDateDayOfWeek(t.scheduledDate);
      if (taskDay !== day) return false;
      // å¼€å§‹æ—¶é—´åœ¨è¯¥è¡Œæ—¶æ®µå†…
      return t.startTime >= rowStart && t.startTime < rowEnd;
    });

    if (task) {
      const info = new TaskSlotInfo();
      info.task = task;
      info.isStart = true; // ä»»åŠ¡åªæ˜¾ç¤ºåœ¨å¼€å§‹æ—¶é—´æ‰€åœ¨è¡Œ
      return info;
    }

    return null;
  }

  // è®¡ç®—ä»»åŠ¡åœ¨æ ¼å­å†…çš„å‚ç›´ä½ç½®ï¼ˆæŒ‰æ—¶é—´æ¯”ä¾‹ï¼‰
  getTaskOffset(task: StudyTask, rowStart: string): number {
    // å°†æ—¶é—´è½¬ä¸ºåˆ†é’Ÿ
    const parseTime = (t: string): number => {
      const parts = t.split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    };

    const taskStartMin = parseTime(task.startTime);
    const rowStartMin = parseTime(rowStart);

    // æ¯æ ¼50åƒç´ é«˜åº¦ï¼Œè®¡ç®—åç§»ä½ç½®
    const diffMinutes = taskStartMin - rowStartMin;
    // å‡è®¾æ¯æ ¼çº¦50åˆ†é’Ÿï¼Œè®¡ç®—æ¯”ä¾‹
    const offsetRatio = diffMinutes / 50;
    return Math.max(0, Math.min(30, offsetRatio * 50)); // é™åˆ¶åœ¨0-30èŒƒå›´
  }

  // è®¡ç®—ä»»åŠ¡åœ¨æ•´ä¸ªè¯¾è¡¨ä¸­çš„ç»å¯¹ä½ç½®
  getTaskAbsolutePosition(task: StudyTask): TaskPosition {
    const taskDay = this.getDateDayOfWeek(task.scheduledDate);
    const result = new TaskPosition();

    // æ‰¾åˆ°ä»»åŠ¡æ‰€åœ¨çš„è¡Œ
    let rowIndex = -1;
    for (let i = 0; i < this.rows.length; i++) {
      const rowStart = this.rows[i].start;
      const rowEnd = this.rows[i].end;
      if (task.startTime >= rowStart && task.startTime < rowEnd) {
        rowIndex = i;
        break;
      }
    }

    if (rowIndex === -1) return result;

    // è®¡ç®—xä½ç½®ï¼šå·¦ä¾§æ—¶é—´åˆ—56åƒç´  + (day-1) * æ¯åˆ—å®½åº¦
    // æ¯åˆ—å®½åº¦éœ€è¦åŠ¨æ€è®¡ç®—ï¼Œå‡è®¾å±å¹•å®½åº¦çº¦360ï¼Œ7åˆ—å‡åˆ†: (360-56)/7 â‰ˆ 43
    const colWidth = 43; // è¿‘ä¼¼å€¼
    result.x = 56 + (taskDay - 1) * colWidth;

    // è®¡ç®—yä½ç½®ï¼šå¤´éƒ¨é«˜åº¦30 + rowIndex * 50 + æ ¼å­å†…åç§»
    const headerHeight = 30;
    const rowHeight = 50;
    const inCellOffset = this.getTaskOffset(task, this.rows[rowIndex].start);
    result.y = headerHeight + rowIndex * rowHeight + inCellOffset;
    result.rowIndex = rowIndex;

    return result;
  }

  // æ ¹æ®æ‹–æ‹½è·ç¦»è®¡ç®—æ–°çš„å¼€å§‹æ—¶é—´
  calculateNewTimeFromDrag(originalTime: string, dragDeltaY: number): string {
    const parseTime = (t: string): number => {
      const parts = t.split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    };

    const formatTime = (minutes: number): string => {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    };

    // è®¡ç®—æ—¶é—´å˜åŒ–ï¼ˆæ¯50åƒç´  â‰ˆ 50åˆ†é’Ÿï¼ŒæŒ‰5åˆ†é’Ÿå–æ•´ï¼‰
    const deltaMinutes = Math.round(dragDeltaY / 50 * 50 / 5) * 5;
    const originalMinutes = parseTime(originalTime);
    let newMinutes = originalMinutes + deltaMinutes;

    // é™åˆ¶æ—¶é—´èŒƒå›´ (6:00 - 22:00)
    newMinutes = Math.max(6 * 60, Math.min(22 * 60, newMinutes));

    return formatTime(newMinutes);
  }

  // å¤„ç†æ‹–æ‹½ç»“æŸï¼ˆåªæ”¯æŒä¸Šä¸‹æ‹–åŠ¨æ”¹å˜æ—¶é—´ï¼‰
  async handleDragEnd(task: StudyTask, totalOffsetY: number, totalOffsetX: number) {
    if (Math.abs(totalOffsetY) < 10) {
      // åç§»å¤ªå°ï¼Œè§†ä¸ºç‚¹å‡»è€Œéæ‹–æ‹½
      this.isDragging = false;
      this.draggingTask = null;
      this.dragOffsetY = 0;
      this.dragOffsetX = 0;
      return;
    }

    const newStartTime = this.calculateNewTimeFromDrag(task.startTime, totalOffsetY);

    if (newStartTime === task.startTime) {
      // æ—¶é—´æ²¡å˜
      this.isDragging = false;
      this.draggingTask = null;
      this.dragOffsetY = 0;
      this.dragOffsetX = 0;
      return;
    }

    Logger.info(`Dragging task ${task.title}: ${task.startTime} -> ${newStartTime}`);

    try {
      const response = await StudyTaskService.updateStudyTask(this.context!, task.taskId, {
        title: task.title,
        scheduledDate: task.scheduledDate,
        startTime: newStartTime,
        endTime: newStartTime,
        assignmentId: '',
        estimatedHours: 0,
        description: ''
      });

      if (response.code === 200) {
        Logger.info('Task time updated via drag');
        this.loadSchedule();
      } else {
        Logger.error('Failed to update task:', response.message);
      }
    } catch (err) {
      Logger.error('Drag update failed:', JSON.stringify(err));
    } finally {
      this.isDragging = false;
      this.draggingTask = null;
      this.dragOffsetY = 0;
      this.dragOffsetX = 0;
    }
  }

  getSlotInfo(day: number, rowIndex: number): SlotInfo | null {
    const rowStart = this.rows[rowIndex].start;
    const rowEnd = this.rows[rowIndex].end;
    
    // æŸ¥æ‰¾è¯¥å¤©æ˜¯å¦æœ‰è¯¾ç¨‹
    const daily = this.weekData.schedule.find(d => d.dayOfWeek === day);
    if (!daily) return null;

    // é€»è¾‘ä¿®æ­£ï¼šå¯»æ‰¾æ˜¯å¦æœ‰è¯¾ç¨‹è¦†ç›–å½“å‰è¡Œ
    // å¹¶ä¸”ï¼šå¦‚æœæ˜¯è¯¥è¯¾ç¨‹è¦†ç›–çš„ç¬¬ä¸€ä¸ªè¡Œï¼Œåˆ™æ ‡è®°ä¸º isStart (æ˜¾ç¤ºæ–‡å­—)
    const course = daily.timeSlots.find(slot => {
       // æ£€æŸ¥è¯¾ç¨‹æ—¶é—´æ®µæ˜¯å¦åŒ…å«å½“å‰è¡Œæ—¶é—´æ®µ (å“ªæ€•ä¸€éƒ¨åˆ†)
       // ç®€å•åˆ¤æ–­: !(courseEnd <= rowStart || courseStart >= rowEnd)
       return slot.endTime > rowStart && slot.startTime < rowEnd;
    });

    if (course) {
       const info = new SlotInfo();
       info.course = course;
       
       // åˆ¤æ–­æ˜¯å¦æ˜¯è¯¥è¯¾ç¨‹çš„â€œé¦–è¡Œâ€
       // æ–¹æ³•ï¼šåœ¨ rows æ•°ç»„ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸è¯¥è¯¾ç¨‹é‡å çš„è¡Œ
       // å¦‚æœ rowIndex å°±æ˜¯é‚£ä¸ªé¦–è¡Œçš„ indexï¼Œåˆ™æ˜¯ isStart
       const firstOverlapRowIndex = this.rows.findIndex(r => 
           course.endTime > r.start && course.startTime < r.end
       );
       
       if (firstOverlapRowIndex === rowIndex) {
         info.isStart = true;
       } else {
         info.isStart = false; 
       }
       return info;
    }

    return null;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ : å­¦æœŸé€‰æ‹© + title + æ·»åŠ 
        Row() {
          Select(this.semesterOptions)
            .value(this.currentSemester)
            .selected(0) // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæˆ–åŒ¹é…é€»è¾‘
            .onSelect((index, value) => {
               this.currentSemester = value; 
               this.loadSchedule();
            })
            .font({ size: 14 })
            .height(32)
            .backgroundColor('#f0f0f0')
            .borderRadius(8)
            .margin({ right: 10 })
  
          Button({ type: ButtonType.Circle, stateEffect: true }) {
             Text('<').fontColor(Color.Black).fontSize(20)
          }
          .width(32).height(32).backgroundColor('#f0f0f0')
          .onClick(() => { if (this.currentWeekIndex > 1) { this.currentWeekIndex--; this.loadSchedule(); } })
          
          Text(`ç¬¬ ${this.currentWeekIndex} å‘¨`).fontSize(18).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center)
          
          Button({ type: ButtonType.Circle, stateEffect: true }) {
             Text('>').fontColor(Color.Black).fontSize(20)
          }
          .width(32).height(32).backgroundColor('#f0f0f0')
          .onClick(() => { this.currentWeekIndex++; this.loadSchedule(); })

          // å¯¼å…¥æŒ‰é’®
          Button({ type: ButtonType.Circle, stateEffect: true }) {
             Text('ğŸ“¥').fontSize(16)
          }
          .width(32).height(32).margin({ left: 10 }).backgroundColor('#f0f0f0')
          .onClick(() => router.pushUrl({ url: 'pages/CourseImportPage' }))
          
          Button({ type: ButtonType.Circle, stateEffect: true }) {
             Text('+').fontColor(Color.White).fontSize(24).margin({ bottom: 2 })
          }
          .width(32).height(32).margin({ left: 6 }).backgroundColor('#007DFF')
          .onClick(() => router.pushUrl({ url: 'pages/CourseAddPage' }))
        }
        .padding(10).backgroundColor(Color.White)
        .width('100%')
  
        Row() {
          Text('').width(56)
          ForEach(this.weekDays, (day: string) => {
            Text(day).layoutWeight(1).textAlign(TextAlign.Center).fontSize(12).fontColor(Color.Gray)
          })
        }.height(30).backgroundColor('#fafafa')
  
        // æ»šåŠ¨åŒºåŸŸ
        Scroll() {
          // ä½¿ç”¨StackåŒ…è£¹è¯¾è¡¨å’Œä»»åŠ¡ï¼Œç¡®ä¿ä»»åŠ¡éšè¯¾è¡¨æ»šåŠ¨å¹¶åœ¨æœ€ä¸Šå±‚
          Stack({ alignContent: Alignment.TopStart }) {
            // åº•å±‚ï¼šè¯¾è¡¨å†…å®¹ï¼ˆèƒŒæ™¯+è¯¾ç¨‹ï¼‰
            Column() {
              ForEach(this.rows, (row: ScheduleRow, rowIndex: number) => {
                Row() {
                  Column() {
                    Text(row.label)
                        .fontSize(12)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(row.type === 1 ? Color.Gray : Color.Black)
                    
                    if (row.label !== 'æ™šé¥­' && row.label !== 'æ™šä¼‘' && row.label !== 'åˆä¼‘') {
                        Text(`${row.start}-${row.end}`)
                            .fontSize(9)
                            .fontColor(Color.Gray)
                            .margin({ top: 2 })
                    }
                  }
                  .width(56).height(50).justifyContent(FlexAlign.Center).backgroundColor('#fafafa')
                  .border({ width: { bottom: 1 }, color: '#f0f0f0' })
    
                  ForEach([1,2,3,4,5,6,7], (day: number) => {
                    // å†…å±‚Stackç”¨äºæ ¼å­èƒŒæ™¯å’Œè¯¾ç¨‹
                    Stack() {
                      if (row.type === 1) {
                         Rect().width('100%').height('100%').fill('#f5f5f5')
                      } else {
                         Rect().width('100%').height('100%').fill(Color.White).stroke('#f0f0f0').strokeWidth(0.5)
                      }
    
                      // æ˜¾ç¤ºè¯¾ç¨‹
                      if (this.getSlotInfo(day, rowIndex)) {
                        Column() {
                          if (this.getSlotInfo(day, rowIndex)?.isStart) {
                            Text(this.getSlotInfo(day, rowIndex)?.course.course.courseName)
                              .fontSize(10).fontColor(Color.Black).fontWeight(FontWeight.Bold)
                              .maxLines(2).textOverflow({ overflow: TextOverflow.Ellipsis })
                            Text(this.getSlotInfo(day, rowIndex)?.course.course.location)
                              .fontSize(9).fontColor(Color.Black)
                          }
                        }
                        .width('100%').height('100%')
                        .backgroundColor(this.getSafeColor(this.getSlotInfo(day, rowIndex)?.course.course.courseName || ''))
                        .padding(2)
                        .onClick(async () => {
                            const info = this.getSlotInfo(day, rowIndex);
                            if (info && info.course && info.course.course) {
                                this.isLoading = true;
                                try {
                                    const res = await CourseService.getCourseById(this.context!, info.course.course.courseId, this.currentSemester);
                                    if (res.code === 200 && res.data) {
                                        this.showCourseDetail(res.data, info.course);
                                    } else {
                                        Logger.error('Get details failed:', res.message);
                                    }
                                } catch (e) {
                                    Logger.error('Get details failed', JSON.stringify(e));
                                } finally {
                                    this.isLoading = false;
                                }
                            }
                        })
                      }
                    }
                    .layoutWeight(1)
                    .height(50)
                    // æ‰€æœ‰æ ¼å­é•¿æŒ‰äº‹ä»¶
                    .gesture(
                      LongPressGesture({ repeat: false })
                        .onAction(() => {
                          // æ— ä»»åŠ¡æ—¶å¯åˆ›å»ºï¼ˆè¯¾ç¨‹ä¸Šä¹Ÿå¯ä»¥åˆ›å»ºä»»åŠ¡ï¼‰
                          if (!this.getTaskInfo(day, rowIndex)) {
                            this.openNewTaskDialog(day, row.start);
                          }
                        })
                    )
                  })
                }
              })
            }
            .width('100%') // Columnå®½åº¦å……æ»¡

            // é¡¶å±‚ï¼šç»Ÿä¸€æ¸²æŸ“æ‰€æœ‰ä»»åŠ¡ï¼Œä½¿ç”¨ç»å¯¹å®šä½ï¼ŒéšStackä¸€èµ·æ»šåŠ¨
            ForEach(this.studyTasks, (task: StudyTask) => {
              Row() {
                Circle()
                  .width(10)
                  .height(10)
                  .fill(task.status === 'completed' ? '#28a745' : Color.Transparent)
                  .stroke('#28a745')
                  .strokeWidth(2)
                  .margin({ left: 1, right: 2 })
                Text(task.title)
                  .fontSize(8)
                  .fontColor('#333')
                  .fontWeight(FontWeight.Medium)
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .layoutWeight(1)
              }
              .width(40)
              .height(16)
              .backgroundColor(this.isDragging && this.draggingTask?.taskId === task.taskId ? '#e3f2fd' : Color.White)
              .border({ width: 1.5, color: this.isDragging && this.draggingTask?.taskId === task.taskId ? '#007DFF' : '#333' })
              .borderRadius(3)
              .padding({ left: 1, right: 2 })
              .alignItems(VerticalAlign.Center)
              .position({
                x: this.getTaskAbsolutePosition(task).x,
                y: this.getTaskAbsolutePosition(task).y + (this.draggingTask?.taskId === task.taskId ? this.dragOffsetY : 0)
              })
              .gesture(
                GestureGroup(GestureMode.Parallel,
                  PanGesture({ direction: PanDirection.Vertical })
                    .onActionStart(() => {
                      this.isDragging = true;
                      this.draggingTask = task;
                      this.dragOffsetY = 0;
                    })
                    .onActionUpdate((event: GestureEvent) => {
                      if (this.isDragging && event) {
                        this.dragOffsetY = event.offsetY;
                      }
                    })
                    .onActionEnd(() => {
                      if (this.draggingTask) {
                        this.handleDragEnd(this.draggingTask, this.dragOffsetY, 0);
                      }
                    }),
                  TapGesture()
                    .onAction(() => {
                      if (!this.isDragging) {
                        this.openEditTaskDialog(task);
                      }
                    })
                )
              )
            })
          }
          .width('100%') // Stackå®½åº¦å……æ»¡Scroll
        }
        .layoutWeight(1) // Scrollé«˜åº¦å……æ»¡å‰©ä½™ç©ºé—´
        .align(Alignment.TopStart) // å†…å®¹é¡¶éƒ¨å¯¹é½
        .width('100%').height('100%').backgroundColor(Color.White)
      }

      
      if (this.isLoading) {
          // Loading Mask
          Stack() {
              LoadingProgress().color(Color.Blue).width(50).height(50)
          }
          .width('100%').height('100%')
          .backgroundColor('rgba(255,255,255,0.5)')
          .position({ x: 0, y: 0 })
      }
    }
  }
}
