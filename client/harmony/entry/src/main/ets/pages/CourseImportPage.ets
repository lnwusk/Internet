import common from '@ohos.app.ability.common';
import router from '@ohos.router';
import { picker } from '@kit.CoreFileKit';
import { fileIo } from '@kit.CoreFileKit';
import { Logger } from '../common/utils/Logger';
import { SyncService } from '../services/SyncService';
import { ImportedCourse, CourseScheduleItem } from '../common/models/ApiModels';

@Entry
@Component
export struct CourseImportPage {
  @State isLoading: boolean = false;
  @State loadingText: string = '';
  @State selectedFileName: string = '';
  @State selectedFileUri: string = '';
  @State parsedCourses: ImportedCourse[] = [];
  @State totalCourses: number = 0;
  @State totalSchedules: number = 0;
  @State showPreview: boolean = false;
  @State errorMessage: string = '';
  @State currentSemester: string = '2025-2026-1';

  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
  private weekDays: string[] = ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'];

  // ÈÄâÊã©Êñá‰ª∂
  async selectFile() {
    try {
      const options = new picker.DocumentSelectOptions();
      options.maxSelectNumber = 1;
      options.fileSuffixFilters = ['.xlsx', '.xls'];

      const documentPicker = new picker.DocumentViewPicker(this.context);
      const result = await documentPicker.select(options);

      if (result && result.length > 0) {
        const uri = result[0];
        const fileName = uri.split('/').pop() || 'timetable.xlsx';

        this.selectedFileUri = uri;
        this.selectedFileName = fileName;
        this.errorMessage = '';

        Logger.info(`Selected file: ${fileName}, URI: ${uri}`);
      }
    } catch (err) {
      Logger.error('File selection failed:', JSON.stringify(err));
      this.errorMessage = 'Êñá‰ª∂ÈÄâÊã©Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
    }
  }

  // ‰∏ä‰º†Âπ∂Ëß£ÊûêÊñá‰ª∂
  async uploadFile() {
    if (!this.selectedFileUri) {
      this.errorMessage = 'ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂';
      return;
    }

    this.isLoading = true;
    this.loadingText = 'Ê≠£Âú®Ëß£ÊûêËØæË°®...';
    this.errorMessage = '';

    try {
      // Â∞ÜpickerËøîÂõûÁöÑURIÂ§çÂà∂Âà∞Ê≤ôÁÆ±ÔºåËé∑ÂèñÂèØÁî®‰∫é‰∏ä‰º†ÁöÑË∑ØÂæÑ
      const sandboxPath = `${this.context.cacheDir}/temp_upload.xlsx`;

      // ÊâìÂºÄÊ∫êÊñá‰ª∂ËØªÂèñ
      const srcFile = await fileIo.open(this.selectedFileUri, fileIo.OpenMode.READ_ONLY);
      const destFile = await fileIo.open(sandboxPath, fileIo.OpenMode.READ_WRITE | fileIo.OpenMode.CREATE);

      // ËØªÂèñÂπ∂ÂÜôÂÖ•
      const buffer = new ArrayBuffer(10 * 1024 * 1024);  // 10MB buffer
      const readLen = await fileIo.read(srcFile.fd, buffer);
      await fileIo.write(destFile.fd, buffer, { length: readLen });

      await fileIo.close(srcFile);
      await fileIo.close(destFile);

      // Ë∞ÉÁî®‰∏ä‰º†Êé•Âè£
      const response = await SyncService.uploadCourseFile(
        this.context,
        sandboxPath,
        this.selectedFileName,
        this.currentSemester
      );

      if (response.code === 200 && response.data) {
        this.parsedCourses = response.data.courses;
        this.totalCourses = response.data.summary.totalCourses;
        this.totalSchedules = response.data.summary.totalSchedules;
        this.showPreview = true;
        Logger.info(`Parsed ${this.totalCourses} courses`);
      } else {
        this.errorMessage = response.message || 'Ëß£ÊûêÂ§±Ë¥•';
      }
    } catch (err) {
      Logger.error('Upload failed:', JSON.stringify(err));
      this.errorMessage = '‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
    } finally {
      this.isLoading = false;
      this.loadingText = '';
    }
  }

  // Á°ÆËÆ§ÂØºÂÖ•
  async confirmImport() {
    if (this.parsedCourses.length === 0) {
      return;
    }

    this.isLoading = true;
    this.loadingText = 'Ê≠£Âú®‰øùÂ≠òËØæÁ®ã...';

    try {
      const response = await SyncService.confirmCourses(
        this.context,
        this.parsedCourses,
        this.currentSemester
      );

      if (response.code === 200 && response.data) {
        Logger.info(`Saved ${response.data.savedCount} courses`);
        // ËøîÂõûËØæË°®È°µÈù¢
        router.back();
      } else {
        this.errorMessage = response.message || '‰øùÂ≠òÂ§±Ë¥•';
      }
    } catch (err) {
      Logger.error('Confirm failed:', JSON.stringify(err));
      this.errorMessage = '‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
    } finally {
      this.isLoading = false;
      this.loadingText = '';
    }
  }

  // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫
  formatSchedule(schedule: CourseScheduleItem[]): string {
    return schedule.map(s => {
      const day = this.weekDays[s.dayOfWeek - 1] || '';
      return `${day} ${s.startTime}-${s.endTime}`;
    }).join(', ');
  }

  // Ê†ºÂºèÂåñÂë®Ê¨°ÊòæÁ§∫
  formatWeeks(weeks: number[]): string {
    if (!weeks || weeks.length === 0) return '';
    if (weeks.length > 2 && weeks[weeks.length - 1] - weeks[0] === weeks.length - 1) {
      return `${weeks[0]}-${weeks[weeks.length - 1]}Âë®`;
    }
    return `Á¨¨${weeks.slice(0, 3).join(',')}${weeks.length > 3 ? '...' : ''}Âë®`;
  }

  build() {
    Stack() {
      Column() {
        // È°∂ÈÉ®ÂØºËà™
        Row() {
          Button({ type: ButtonType.Circle }) {
            Text('‚Üê').fontSize(20).fontColor('#333')
          }
          .width(36).height(36).backgroundColor('#f5f5f5')
          .onClick(() => router.back())

          Text('ÂØºÂÖ•ËØæË°®')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Blank().width(36)
        }
        .padding(12)
        .width('100%')

        // ‰∏ªË¶ÅÂÜÖÂÆπÂå∫
        if (!this.showPreview) {
          // Êñá‰ª∂ÈÄâÊã©ËßÜÂõæ
          Column() {
            Image($r('app.media.startIcon'))
              .width(80)
              .height(80)
              .margin({ top: 60, bottom: 20 })

            Text('ÂØºÂÖ•xlsxËØæË°®Êñá‰ª∂')
              .fontSize(18)
              .fontColor('#333')
              .margin({ bottom: 8 })

            Text('ÊîØÊåÅ‰ªéÊïôÂä°Á≥ªÁªüÂØºÂá∫ÁöÑxlsxÊàñxlsÊ†ºÂºèËØæË°®')
              .fontSize(14)
              .fontColor('#999')
              .margin({ bottom: 30 })

            // ÈÄâÊã©Êñá‰ª∂ÊåâÈíÆ
            Button('ÈÄâÊã©Êñá‰ª∂')
              .width('80%')
              .height(48)
              .backgroundColor('#007DFF')
              .onClick(() => this.selectFile())

            // Â∑≤ÈÄâÊã©Êñá‰ª∂ÊòæÁ§∫
            if (this.selectedFileName) {
              Row() {
                Text('üìÑ').fontSize(16)
                Text(this.selectedFileName)
                  .fontSize(14)
                  .fontColor('#333')
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .layoutWeight(1)
                  .margin({ left: 8 })
              }
              .padding(12)
              .margin({ top: 20 })
              .backgroundColor('#f5f5f5')
              .borderRadius(8)
              .width('80%')

              // ÂºÄÂßãËß£ÊûêÊåâÈíÆ
              Button('ÂºÄÂßãËß£Êûê')
                .width('80%')
                .height(48)
                .backgroundColor('#28a745')
                .margin({ top: 16 })
                .onClick(() => this.uploadFile())
            }

            // ÈîôËØØÊ∂àÊÅØ
            if (this.errorMessage) {
              Text(this.errorMessage)
                .fontSize(14)
                .fontColor('#dc3545')
                .margin({ top: 16 })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)

        } else {
          // È¢ÑËßàËßÜÂõæ
          Column() {
            // ÊëòË¶Å
            Row() {
              Text(`ÂÖ± ${this.totalCourses} Èó®ËØæÁ®ãÔºå${this.totalSchedules} ‰∏™Êó∂Èó¥ÊÆµ`)
                .fontSize(14)
                .fontColor('#666')
            }
            .padding(12)
            .width('100%')
            .backgroundColor('#f8f9fa')

            // ËØæÁ®ãÂàóË°®
            List({ space: 8 }) {
              ForEach(this.parsedCourses, (course: ImportedCourse) => {
                ListItem() {
                  Column() {
                    Row() {
                      Text(course.courseName)
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#333')
                        .layoutWeight(1)
                      if (course.credits > 0) {
                        Text(`${course.credits}Â≠¶ÂàÜ`)
                          .fontSize(12)
                          .fontColor('#999')
                      }
                    }.width('100%')

                    if (course.teacher) {
                      Text(`ÊïôÂ∏à: ${course.teacher}`)
                        .fontSize(14)
                        .fontColor('#666')
                        .margin({ top: 4 })
                    }

                    Text(this.formatSchedule(course.schedule))
                      .fontSize(13)
                      .fontColor('#007DFF')
                      .margin({ top: 4 })

                    if (course.schedule.length > 0 && course.schedule[0].weeks.length > 0) {
                      Text(this.formatWeeks(course.schedule[0].weeks))
                        .fontSize(12)
                        .fontColor('#999')
                        .margin({ top: 2 })
                    }
                  }
                  .padding(12)
                  .backgroundColor(Color.White)
                  .borderRadius(8)
                  .width('100%')
                  .alignItems(HorizontalAlign.Start)
                }
              })
            }
            .layoutWeight(1)
            .padding({ left: 12, right: 12 })

            // Â∫ïÈÉ®ÊåâÈíÆ
            Row() {
              Button('ÂèñÊ∂à')
                .layoutWeight(1)
                .height(48)
                .backgroundColor('#6c757d')
                .margin({ right: 8 })
                .onClick(() => {
                  this.showPreview = false;
                  this.parsedCourses = [];
                })

              Button('Á°ÆËÆ§ÂØºÂÖ•')
                .layoutWeight(1)
                .height(48)
                .backgroundColor('#28a745')
                .margin({ left: 8 })
                .onClick(() => this.confirmImport())
            }
            .padding(12)
            .width('100%')

            // ÈîôËØØÊ∂àÊÅØ
            if (this.errorMessage) {
              Text(this.errorMessage)
                .fontSize(14)
                .fontColor('#dc3545')
                .margin({ bottom: 8 })
            }
          }
          .width('100%')
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')

      // Âä†ËΩΩÈÅÆÁΩ©
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color(Color.White)
          Text(this.loadingText)
            .fontSize(14)
            .fontColor(Color.White)
            .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }
}
