import common from '@ohos.app.ability.common';
import router from '@ohos.router';
import { HttpUtil } from '../common/utils/HttpUtil';
import { Logger } from '../common/utils/Logger';
import { WeekView } from './WeekView';

@Entry
@Component
struct Index {
  @State selectedIndex: number = 0;

  aboutToAppear() {
    this.checkLogin();
  }

  async checkLogin() {
    const context = getContext(this) as common.UIAbilityContext;
    const token = await HttpUtil.getToken(context);
    Logger.info('Current Token:', token);
    
    if (!token) {
      router.replaceUrl({ url: 'pages/LoginPage' });
    }
  }

  build() {
    Tabs({ barPosition: BarPosition.End, index: this.selectedIndex }) {
      // Tab 1: è¯¾è¡¨
      TabContent() {
        WeekView()
      }
      .tabBar('è¯¾è¡¨')

      // Tab 2: ä½œä¸š (å ä½)
      TabContent() {
        Column() {
          Text('ä½œä¸šç®¡ç† (å¼€å‘ä¸­...)')
            .fontSize(20)
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .height('100%')
      }
      .tabBar('ä½œä¸š')

      // Tab 3: æˆ‘çš„
      TabContent() {
        Scroll() {
          Column() {
            // ç”¨æˆ·å¤´åƒåŒºåŸŸ
            Column() {
              Text('ðŸ‘¤')
                .fontSize(48)
                .margin({ top: 30, bottom: 8 })
              Text('ç”¨æˆ·')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
            .padding({ bottom: 20 })

            // åŠŸèƒ½åˆ—è¡¨
            Column() {
              // é€šçŸ¥è®¾ç½®
              Row() {
                Text('ðŸ””').fontSize(20)
                Text('é€šçŸ¥è®¾ç½®')
                  .fontSize(16)
                  .margin({ left: 12 })
                  .layoutWeight(1)
                Text('>').fontSize(16).fontColor('#999')
              }
              .padding(16)
              .width('100%')
              .backgroundColor(Color.White)
              .borderRadius({ topLeft: 12, topRight: 12 })
              .onClick(() => router.pushUrl({ url: 'pages/NotificationSettingsPage' }))

              Divider().color('#f0f0f0')

              // é€šçŸ¥åŽ†å²
              Row() {
                Text('ðŸ“‹').fontSize(20)
                Text('é€šçŸ¥åŽ†å²')
                  .fontSize(16)
                  .margin({ left: 12 })
                  .layoutWeight(1)
                Text('>').fontSize(16).fontColor('#999')
              }
              .padding(16)
              .width('100%')
              .backgroundColor(Color.White)
              .borderRadius({ bottomLeft: 12, bottomRight: 12 })
              .onClick(() => router.pushUrl({ url: 'pages/NotificationHistoryPage' }))
            }
            .margin({ top: 20, left: 16, right: 16 })

            // é€€å‡ºç™»å½•
            Button('é€€å‡ºç™»å½•')
              .width('90%')
              .height(48)
              .backgroundColor('#dc3545')
              .margin({ top: 40 })
              .onClick(async () => {
                const context = getContext(this) as common.UIAbilityContext;
                await HttpUtil.clearToken(context);
                router.replaceUrl({ url: 'pages/LoginPage' });
              })
          }
          .width('100%')
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#f5f5f5')
      }
      .tabBar('æˆ‘çš„')
    }
    .width('100%')
    .height('100%')
    .onChange((index: number) => {
      this.selectedIndex = index;
    })
  }
}